Bootstrap: docker
From: nvidia/cuda:11.3.1-devel-ubuntu18.04

%files
./third_party/PatchmatchNet /app

%post
apt-get update && apt-get -y upgrade
apt-get -y install \
build-essential \
wget \
bzip2 \
ca-certificates \
libglib2.0-0 \
libxext6 \
libsm6 \
libxrender1 \
git \
ffmpeg \
libsm6 \
libxext6
rm -rf /var/lib/apt/lists/*
apt-get clean

#Installing Anaconda 3 
wget -c https://repo.anaconda.com/archive/Anaconda3-2020.02-Linux-x86_64.sh
/bin/bash Anaconda3-2020.02-Linux-x86_64.sh -bfp /usr/local

#Conda configuration of channels from .condarc file
conda config --file /.condarc --add channels defaults
conda config --file /.condarc --add channels conda-forge
conda update conda

conda env create -f /app/environment.yml
echo ". /home/ciirc/anaconda3/etc/profile.d/conda.sh" >> $SINGULARITY_ENVIRONMENT
echo "conda activate meshroom" >> $SINGULARITY_ENVIRONMENT
cd /app

%environment
export PYTHONPATH=/app

%runscript
. /home/ciirc/anaconda3/etc/profile.d/conda.sh
conda activate meshroom
cd /app
exec "$@"

%startscript
. /home/ciirc/anaconda3/etc/profile.d/conda.sh
conda activate meshroom 
cd /app